# =============================================
# GitHub Actions Workflow for PTF Framework
# =============================================
# This workflow runs Playwright tests on GitHub Actions.
#
# Features:
# - Automatic runs on push to main/dev1 and PRs
# - Manual dispatch with test suite selection
# - Parallel execution with sharding (4 shards)
# - Multiple test types (smoke, a11y, visual, performance)
# - Allure report generation and GitHub Pages deployment
#
# Manual Run:
# 1. Go to Actions > Playwright Tests
# 2. Click "Run workflow"
# 3. Select test_suite, environment, and shards
#
# @see https://docs.github.com/actions
# =============================================

name: Playwright Tests

# =============================================
# Trigger Configuration
# =============================================
on:
  # Automatic triggers
  push:
    branches: [main, dev1] # Run on pushes to these branches
  pull_request:
    branches: [main] # Run on PRs to main

  # Manual trigger with parameters
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options: [all, smoke, sanity, regression, api, a11y, visual, performance]
      environment:
        description: 'Test environment'
        required: false
        default: 'sit'
        type: choice
        options: [sit, fat, uat]
      shards:
        description: 'Number of shards for parallel execution'
        required: false
        default: '1'
        type: choice
        options: ['1', '2', '4', '8']

# =============================================
# Environment Variables
# =============================================
env:
  TEST_ENV: ${{ github.event.inputs.environment || 'sit' }}

# =============================================
# Jobs
# =============================================
jobs:
  # =============================================
  # Smoke Tests (Fast Feedback)
  # =============================================
  # Runs on every push for quick verification
  # ~5-10 tests, completes in under a minute
  smoke:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suite == '' || github.event.inputs.test_suite == 'smoke'
    steps:
      - uses: actions/checkout@v4

      # Use Node.js version from .nvmrc file
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm' # Cache npm dependencies

      - name: Install dependencies
        run: npm ci

      # Install only Chromium (faster than all browsers)
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run smoke tests
        run: npx playwright test --grep @smoke --project=chromium

      # Upload report even if tests fail
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-report
          path: playwright-report/
          retention-days: 7

  # =============================================
  # Full Test Suite (Sharded)
  # =============================================
  # Runs all tests in parallel across 4 shards
  # Each shard gets 1/4 of the tests
  test:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'regression'
    strategy:
      fail-fast: false # Don't cancel other shards if one fails
      matrix:
        shard: [1, 2, 3, 4] # Run 4 parallel jobs
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Install all browsers for full coverage
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # Run only this shard's portion of tests
      - name: Run tests (shard ${{ matrix.shard }}/4)
        run: npx playwright test --shard=${{ matrix.shard }}/4

      # Upload Playwright HTML report
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-shard-${{ matrix.shard }}
          path: playwright-report/
          retention-days: 30

      # Upload Allure results for combined reporting
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-shard-${{ matrix.shard }}
          path: allure-results/
          retention-days: 30

      # Upload test artifacts only on failure (screenshots, traces)
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: test-results/
          retention-days: 7

  # =============================================
  # Accessibility Tests
  # =============================================
  # WCAG compliance testing using axe-core
  a11y:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suite == 'a11y'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run accessibility tests
        run: npx playwright test --grep @a11y --project=chromium

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: a11y-report
          path: playwright-report/
          retention-days: 30

  # =============================================
  # Visual Regression Tests
  # =============================================
  # Screenshot comparison testing
  visual:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suite == 'visual'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run visual tests
        run: npx playwright test --grep @visual --project=chromium

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-report
          path: playwright-report/
          retention-days: 30

      # Upload baseline/diff images on failure
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-snapshots
          path: tests/**/*.png*
          retention-days: 7

  # =============================================
  # Performance Tests
  # =============================================
  # Core Web Vitals testing
  performance:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_suite == 'performance'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run performance tests
        run: npx playwright test --grep @performance --project=chromium

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-report
          path: playwright-report/
          retention-days: 30

  # =============================================
  # Allure Report Generation
  # =============================================
  # Combines results from all shards into one report
  # Deploys to GitHub Pages for easy viewing
  allure-report:
    runs-on: ubuntu-latest
    needs: test # Wait for all test shards
    if: always() && needs.test.result != 'skipped'
    steps:
      - uses: actions/checkout@v4

      # Download results from all shards
      - name: Download all Allure results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: allure-results
          merge-multiple: true # Merge all into one folder

      # Generate combined Allure report
      - name: Generate Allure report
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results
          allure_report: allure-report
          allure_history: allure-history

      # Deploy to GitHub Pages (main branch only)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report
